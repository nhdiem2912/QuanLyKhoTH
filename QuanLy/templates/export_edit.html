{% extends "base.html" %}
{% load humanize %}
{% block title %}Sửa phiếu xuất - TH True Mart{% endblock %}
{% block page_title %}Sửa phiếu xuất{% endblock %}

{% block content %}
<div class="container-fluid">
  <h4 class="fw-bold mb-3 text-primary">Chỉnh sửa phiếu xuất kho</h4>

  <form method="post" action="{% url 'export_edit' receipt.export_code %}">
    {% csrf_token %}

    <!-- Thông tin phiếu xuất -->
    <div class="card p-3 mb-3 shadow-sm">
      <h6 class="fw-semibold text-primary mb-2">Thông tin phiếu xuất</h6>
      <div class="row g-3">
        <div class="col-md-3">
          {{ form.export_code.label_tag }} {{ form.export_code }}
        </div>
        <div class="col-md-4">
          {{ form.destination.label_tag }} {{ form.destination }}
        </div>
        <div class="col-md-3">
          {{ form.status.label_tag }} {{ form.status }}
        </div>
        <div class="col-md-12">
          {{ form.note.label_tag }} {{ form.note }}
        </div>
      </div>
    </div>

    <!-- Danh sách sản phẩm -->
    <div class="card p-3 mb-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold text-primary mb-0">Danh sách sản phẩm xuất</h6>
        <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
          + Thêm sản phẩm
        </button>
      </div>

      {{ formset.management_form }}
      <table class="table table-bordered align-middle mb-2">
        <thead class="table-light">
          <tr>
            <th>Tên sản phẩm</th>
            <th style="width:120px;">Số lượng</th>
            <th style="width:150px;">Đơn giá (₫)</th>
            <th style="width:120px;">Đơn vị</th>
            <th class="text-center" style="width:60px;">Xóa</th>
          </tr>
        </thead>
        <tbody id="item-body">
          {% for f in formset.forms %}
          <tr class="item-row">
            {{ f.id }}
            <td>{{ f.product }}</td>
            <td>{{ f.quantity }}</td>
            <td>{{ f.unit_price }}</td>
            <td>{{ f.unit }}</td>
            <td class="text-center">{{ f.DELETE }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Hàng mẫu để thêm dòng mới -->
      <template id="empty-row-template">
        <tr class="item-row">
          <td>
            <select name="form-__prefix__-product" class="form-select">
              <option value="">-----</option>
              {% for p in formset.forms.0.fields.product.queryset %}
              <option value="{{ p.pk }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <input type="number" name="form-__prefix__-quantity" class="form-control" placeholder="Nhập số lượng">
          </td>
          <td>
            <input type="number" step="0.01" name="form-__prefix__-unit_price" class="form-control" placeholder="Nhập đơn giá">
          </td>
          <td>
            <input type="text" name="form-__prefix__-unit" class="form-control" placeholder="Nhập đơn vị">
          </td>
          <td class="text-center">
            <input type="checkbox" name="form-__prefix__-DELETE">
          </td>
        </tr>
      </template>
    </div>

    <div class="text-end mt-3">
      <a href="{% url 'export' %}" class="btn btn-secondary">Hủy</a>
      <button type="submit" class="btn btn-success">Lưu phiếu xuất</button>
    </div>
  </form>
</div>

<!-- Script thêm sản phẩm -->
<script>
document.getElementById('add-row').addEventListener('click', () => {
  const tbody = document.getElementById('item-body');
  const totalForms = document.getElementById('id_form-TOTAL_FORMS');
  const formIdx = totalForms.value;
  const tpl = document.getElementById('empty-row-template').innerHTML.replace(/__prefix__/g, formIdx);
  tbody.insertAdjacentHTML('beforeend', tpl);
  totalForms.value = parseInt(formIdx) + 1;
});
</script>

<!-- Giao diện -->
<style>
.card h6 { font-size: 15px; }
.table th, .table td { vertical-align: middle; }
.btn-outline-primary { border-color: #0d6efd; color: #0d6efd; }
.btn-outline-primary:hover { background-color: #0d6efd; color: #fff; }
</style>
{% endblock %}
