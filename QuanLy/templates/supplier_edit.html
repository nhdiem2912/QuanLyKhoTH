{% extends "base.html" %}
{% block title %}Chỉnh sửa nhà cung ứng{% endblock %}
{% block page_title %}Chỉnh sửa nhà cung ứng{% endblock %}

{% block extra_head %}
<style>
    .hero-card {
        border-radius: 16px;
        background: linear-gradient(135deg, #0d6efd, #38bdf8);
        color: #fff;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 10px 25px rgba(15,23,42,0.15);
        margin-bottom: 20px;
    }
    .hero-icon {
        width: 44px; height: 44px;
        border-radius: 999px;
        background: rgba(255,255,255,0.2);
        display: flex; align-items: center; justify-content: center;
        font-size: 22px;
    }
    label { font-weight: 600; margin-bottom: 4px; }
    .section-title {
        font-weight: 600;
        font-size: 17px;
        color: #0d6efd;
        margin-bottom: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- HERO -->
    <div class="hero-card">
        <div>
            <h5>Cập nhật thông tin nhà cung ứng</h5>
            <p>Sửa thông tin NCC theo quyền của bạn.</p>
        </div>
        <div class="hero-icon"><i class="fa-solid fa-pen-to-square"></i></div>
    </div>

    {% if is_supplier and supplier_code != user.username %}
        <!-- NCC cố truy cập NCC khác → silent view trong views.py, còn template phòng ngừa -->
        <div class="alert alert-warning mt-3">
            Bạn không có quyền chỉnh sửa nhà cung ứng này.
        </div>
        <a href="{% url 'suppliers' %}" class="btn btn-secondary mt-2">
            <i class="fa-solid fa-arrow-left me-1"></i> Quay lại
        </a>

    {% else %}
    <form method="post">
        {% csrf_token %}

        <!-- THÔNG TIN NCC -->
        <div class="card p-4 shadow-sm mb-4">
            <div class="section-title">Thông tin nhà cung ứng</div>

            <div class="row g-3">

                {% if not is_supplier %}
                <!-- Manager/Employee thấy đầy đủ -->
                <div class="col-md-4">
                    <label>{{ form.supplier_code.label }}</label>
                    {{ form.supplier_code }}
                    <div class="text-danger small">{{ form.supplier_code.errors }}</div>
                </div>

                <div class="col-md-4">
                    <label>{{ form.tax_code.label }}</label>
                    {{ form.tax_code }}
                    <div class="text-danger small">{{ form.tax_code.errors }}</div>
                </div>

                <div class="col-md-4">
                    <label>{{ form.status.label }}</label>
                    {{ form.status }}
                    <div class="text-danger small">{{ form.status.errors }}</div>
                </div>
                {% endif %}

                <!-- Các trường NCC được sửa -->
                <div class="col-md-8">
                    <label>{{ form.company_name.label }}</label>
                    {{ form.company_name }}
                    <div class="text-danger small">{{ form.company_name.errors }}</div>
                </div>

                <div class="col-md-4">
                    <label>{{ form.contact_name.label }}</label>
                    {{ form.contact_name }}
                    <div class="text-danger small">{{ form.contact_name.errors }}</div>
                </div>

                <div class="col-md-4">
                    <label>{{ form.phone.label }}</label>
                    {{ form.phone }}
                    <div class="text-danger small">{{ form.phone.errors }}</div>
                </div>

                <div class="col-md-6">
                    <label>{{ form.email.label }}</label>
                    {{ form.email }}
                    <div class="text-danger small">{{ form.email.errors }}</div>
                </div>

                <div class="col-md-6">
                    <label>{{ form.address.label }}</label>
                    {{ form.address }}
                    <div class="text-danger small">{{ form.address.errors }}</div>
                </div>

            </div>
        </div>

        {% if not is_supplier %}
        <!-- FORMSET SẢN PHẨM – chỉ cho Manager/Employee -->
        <div class="card p-4 shadow-sm mb-4">
            <div class="section-title">Sản phẩm NCC cung cấp</div>

            {{ formset.management_form }}

            <table class="table table-bordered text-center">
                <thead class="table-light">
                    <tr>
                        <th>Mã SP NCC</th>
                        <th>Tên SP NCC</th>
                        <th>Danh mục</th>
                        <th>Đơn giá NCC</th>
                        <th>Đang cung cấp</th>
                        <th>Xóa</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in formset.forms %}
                    <tr>
                        {{ f.id }}
                        <td>{{ f.product_code }}</td>
                        <td>{{ f.name }}</td>
                        <td>{{ f.category }}</td>
                        <td>{{ f.unit_price }}</td>
                        <td>{{ f.is_active }}</td>
                        <td>{% if formset.can_delete %}{{ f.DELETE }}{% endif %}</td>
                    </tr>

                    {% if f.non_field_errors %}
                    <tr><td colspan="6" class="text-danger small">{{ f.non_field_errors }}</td></tr>
                    {% endif %}

                    {% endfor %}
                </tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Danh sách sản phẩm NCC</span>
                <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-plus me-1"></i> Thêm sản phẩm
                </button>
            </div>
        </div>
        {% endif %}

        <div class="text-end">
            <a href="{% url 'suppliers' %}" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left-long me-1"></i> Hủy
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-floppy-disk me-1"></i> Lưu thay đổi
            </button>
        </div>
    </form>
    {% endif %}
</div>

{% endblock %}
