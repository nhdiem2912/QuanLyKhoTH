{% extends "base.html" %}
{% load humanize %}
{% block title %}Tạo phiếu nhập - TH True Mart{% endblock %}
{% block page_title %}Tạo phiếu nhập kho{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- HEADER -->
  <div class="bg-white p-3 rounded-3 shadow-sm mb-4">
    <h5 class="fw-semibold text-primary mb-1">Tạo phiếu nhập kho</h5>
    <small class="text-muted">
      Chọn phiếu ASN để hệ thống tự động điền danh sách sản phẩm, số lượng, đơn giá, đơn vị và hạn sử dụng.
    </small>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- Thông tin chung -->
    <div class="card p-3 mb-4 shadow-sm">
      <h6 class="fw-semibold text-primary mb-2">Thông tin phiếu nhập</h6>
      <div class="row g-3">
        <div class="col-md-3">
          {{ form.import_code.label_tag }}
          {{ form.import_code }}
          <div class="text-muted small mt-1">
            Nếu bỏ trống, hệ thống sẽ tự sinh mã dạng <strong>PN0001</strong>, <strong>PN0002</strong>, ...
          </div>
          {% if form.import_code.errors %}
            <div class="text-danger small">{{ form.import_code.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-3">
          {{ form.supplier.label_tag }}
          {{ form.supplier }}
          <div class="text-muted small mt-1">
            Khi chọn ASN, nhà cung ứng sẽ được tự động đồng bộ theo ASN.
          </div>
          {% if form.supplier.errors %}
            <div class="text-danger small">{{ form.supplier.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-3">
  {{ form.asn.label_tag }}

  <select name="asn" id="id_asn" class="form-select">
      <option value="">---------</option>

      {% for a in available_asn %}
          <option value="{{ a.asn_code }}"
                  {% if form.initial.asn and form.initial.asn.asn_code == a.asn_code %}selected{% endif %}>
              {{ a.asn_code }} — {{ a.supplier.company_name }}
          </option>
      {% endfor %}
  </select>

  {% if form.asn.errors %}
    <div class="text-danger small">{{ form.asn.errors }}</div>
  {% endif %}

  <small class="text-muted d-block mt-1">
    Chỉ hiển thị ASN chưa được nhập kho.
  </small>
</div>


        <div class="col-md-3">
          {{ form.import_date.label_tag }}
          {{ form.import_date }}
          {% if form.import_date.errors %}
            <div class="text-danger small">{{ form.import_date.errors }}</div>
          {% endif %}
        </div>

        <div class="col-12">
          {{ form.note.label_tag }}
          {{ form.note }}
          {% if form.note.errors %}
            <div class="text-danger small">{{ form.note.errors }}</div>
          {% endif %}
        </div>
      </div>

      {% if asn %}
      <hr class="my-3">
      <div class="row g-3 small text-muted">
        <div class="col-md-4">
          <strong>ASN:</strong> {{ asn.asn_code }}<br>
          <strong>Nhà cung ứng:</strong> {{ asn.supplier.company_name }}
        </div>
        <div class="col-md-4">
          <strong>Ngày dự kiến giao:</strong> {{ asn.expected_date|date:"d/m/Y" }}<br>
          <strong>Tổng số dòng sản phẩm:</strong> {{ asn_items|length }}
        </div>
        <div class="col-md-4">
          <strong>Tổng số lượng ASN:</strong>
          {{ asn.total_quantity|default:"0" }} {{ asn_items.0.unit }}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Danh sách sản phẩm -->
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold text-primary mb-0">Danh sách sản phẩm nhập</h6>
        {# Nếu muốn cho nhập tay thêm dòng, có thể thêm nút ở đây #}
      </div>

      {{ formset.management_form }}

      <table class="table table-bordered align-middle text-center">
        <thead class="table-primary">
          <tr>
            <th class="d-none">ASN item</th>
            <th style="width:22%">Sản phẩm</th>
            <th style="width:90px;">SL</th>
            <th style="width:120px;">Đơn giá (₫)</th>
            <th style="width:110px;">Đơn vị</th>
            <th style="width:130px;">Hạn sử dụng</th>
            <th style="width:140px;">Vị trí</th>
            <th style="width:160px;">Thành tiền (₫)</th>
            <th style="width:60px;">Xóa</th>
          </tr>
        </thead>
        <tbody id="item-body">
          {% for f in formset.forms %}
          <tr class="item-row align-middle">
            <!-- Ẩn trường ASN item nhưng vẫn submit -->
            <td class="d-none">
              {{ f.asn_item }}
            </td>

            <td>
              {{ f.product }}
              {% if f.product.errors %}
                <div class="text-danger small">{{ f.product.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.quantity }}
              {% if f.quantity.errors %}
                <div class="text-danger small">{{ f.quantity.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.unit_price }}
              {% if f.unit_price.errors %}
                <div class="text-danger small">{{ f.unit_price.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.unit }}
              {% if f.unit.errors %}
                <div class="text-danger small">{{ f.unit.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.expiry_date }}
              {% if f.expiry_date.errors %}
                <div class="text-danger small">{{ f.expiry_date.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.location }}
              {% if f.location.errors %}
                <div class="text-danger small">{{ f.location.errors }}</div>
              {% endif %}
            </td>

            <td class="text-end total-cell text-primary fw-semibold">0</td>

            <td class="text-center">
              {% if formset.can_delete %}
                {{ f.DELETE }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>

        <tfoot class="table-light fw-semibold">
          <tr>
            <td colspan="7" class="text-end">Tổng cộng:</td>
            <td class="text-end text-primary fs-6" id="grand-total">0 ₫</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Nút hành động -->
    <div class="text-end mt-4">
      <a href="{% url 'import_list' %}" class="btn btn-secondary">
        <i class="fa-solid fa-xmark me-1"></i> Hủy
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-save me-1"></i> Lưu phiếu nhập
      </button>
    </div>
  </form>
</div>

<style>
.table th, .table td { vertical-align: middle !important; }
.table th { font-weight: 600; }
.table input, .table select { height: 36px; font-size: 14px; }
.item-row td { vertical-align: middle !important; }
td label { display: none; }
.total-cell { font-weight: 600; color: #0d6efd; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const asnSelect = document.getElementById("id_asn");
  const grandTotalCell = document.getElementById("grand-total");

  // Khi đổi ASN → reload trang với ?asn=...
  if (asnSelect) {
    asnSelect.addEventListener("change", function() {
      const value = this.value;
      const url = new URL(window.location.href);
      if (value) {
        url.searchParams.set("asn", value);
      } else {
        url.searchParams.delete("asn");
      }
      window.location.href = url.toString();
    });
  }

  // Gắn class để tính tổng
  document.querySelectorAll('input[name$="-quantity"]').forEach(i => i.classList.add("quantity"));
  document.querySelectorAll('input[name$="-unit_price"]').forEach(i => {
    i.classList.add("unit-price");

    // Bỏ .00: convert về số nguyên nếu có giá trị
    if (i.value) {
      const v = parseFloat(i.value);
      if (!isNaN(v)) {
        i.value = parseInt(v);
      }
    }
    // Chỉ cho nhập bước 1 (không số lẻ)
    i.step = "1";
  });

  function calculateTotals() {
    let grand = 0;
    document.querySelectorAll(".item-row").forEach(row => {
      const qty = parseFloat(row.querySelector(".quantity")?.value || 0);
      const price = parseFloat(row.querySelector(".unit-price")?.value || 0);
      const total = qty * price;
      const cell = row.querySelector(".total-cell");
      if (cell) {
        cell.textContent = total ? total.toLocaleString("vi-VN") + " ₫" : "0 ₫";
      }
      grand += total;
    });
    if (grandTotalCell) {
      grandTotalCell.textContent = grand.toLocaleString("vi-VN") + " ₫";
    }
  }

  document.querySelectorAll(".quantity, .unit-price").forEach(i => {
    i.addEventListener("input", calculateTotals);
  });

  setTimeout(calculateTotals, 200);
});
</script>
{% endblock %}
