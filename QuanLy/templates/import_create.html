{% extends "base.html" %}
{% load humanize %}
{% block title %}T·∫°o phi·∫øu nh·∫≠p - TH True Mart{% endblock %}
{% block page_title %}T·∫°o phi·∫øu nh·∫≠p kho{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- HEADER -->
  <div class="bg-white p-3 rounded-3 shadow-sm mb-4">
    <h5 class="fw-semibold text-primary mb-1">T·∫°o phi·∫øu nh·∫≠p kho</h5>
    <small class="text-muted">
      Ch·ªçn phi·∫øu ASN ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅn danh s√°ch s·∫£n ph·∫©m, s·ªë l∆∞·ª£ng, ƒë∆°n gi√°, ƒë∆°n v·ªã v√† h·∫°n s·ª≠ d·ª•ng.
    </small>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- Th√¥ng tin chung -->
    <div class="card p-3 mb-4 shadow-sm">
      <h6 class="fw-semibold text-primary mb-2">Th√¥ng tin phi·∫øu nh·∫≠p</h6>
      <div class="row g-3">
        <div class="col-md-3">
          {{ form.import_code.label_tag }}
          {{ form.import_code }}
          <div class="text-muted small mt-1">
            N·∫øu b·ªè tr·ªëng, h·ªá th·ªëng s·∫Ω t·ª± sinh m√£ d·∫°ng <strong>PN0001</strong>, <strong>PN0002</strong>, ...
          </div>
          {% if form.import_code.errors %}
            <div class="text-danger small">{{ form.import_code.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-3">
          {{ form.supplier.label_tag }}
          {{ form.supplier }}
          <div class="text-muted small mt-1">
            Khi ch·ªçn ASN, nh√† cung ·ª©ng s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ƒë·ªìng b·ªô theo ASN.
          </div>
          {% if form.supplier.errors %}
            <div class="text-danger small">{{ form.supplier.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-3">
  {{ form.asn.label_tag }}

  <select name="asn" id="id_asn" class="form-select">
      <option value="">---------</option>

      {% for a in available_asn %}
          <option value="{{ a.asn_code }}"
                  {% if form.initial.asn and form.initial.asn.asn_code == a.asn_code %}selected{% endif %}>
              {{ a.asn_code }} ‚Äî {{ a.supplier.company_name }}
          </option>
      {% endfor %}
  </select>

  {% if form.asn.errors %}
    <div class="text-danger small">{{ form.asn.errors }}</div>
  {% endif %}

  <small class="text-muted d-block mt-1">
    Ch·ªâ hi·ªÉn th·ªã ASN ch∆∞a ƒë∆∞·ª£c nh·∫≠p kho.
  </small>
</div>


        <div class="col-md-3">
          {{ form.import_date.label_tag }}
          {{ form.import_date }}
          {% if form.import_date.errors %}
            <div class="text-danger small">{{ form.import_date.errors }}</div>
          {% endif %}
        </div>

        <div class="col-12">
          {{ form.note.label_tag }}
          {{ form.note }}
          {% if form.note.errors %}
            <div class="text-danger small">{{ form.note.errors }}</div>
          {% endif %}
        </div>
      </div>

      {% if asn %}
      <hr class="my-3">
      <div class="row g-3 small text-muted">
        <div class="col-md-4">
          <strong>ASN:</strong> {{ asn.asn_code }}<br>
          <strong>Nh√† cung ·ª©ng:</strong> {{ asn.supplier.company_name }}
        </div>
        <div class="col-md-4">
          <strong>Ng√†y d·ª± ki·∫øn giao:</strong> {{ asn.expected_date|date:"d/m/Y" }}<br>
          <strong>T·ªïng s·ªë d√≤ng s·∫£n ph·∫©m:</strong> {{ asn_items|length }}
        </div>
        <div class="col-md-4">
          <strong>T·ªïng s·ªë l∆∞·ª£ng ASN:</strong>
          {{ asn.total_quantity|default:"0" }} {{ asn_items.0.unit }}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold text-primary mb-0">Danh s√°ch s·∫£n ph·∫©m nh·∫≠p</h6>
        {# N·∫øu mu·ªën cho nh·∫≠p tay th√™m d√≤ng, c√≥ th·ªÉ th√™m n√∫t ·ªü ƒë√¢y #}
      </div>

      {{ formset.management_form }}

      <table class="table table-bordered align-middle text-center">
        <thead class="table-primary">
          <tr>
            <th class="d-none">ASN item</th>
            <th style="width:22%">S·∫£n ph·∫©m</th>
            <th style="width:90px;">SL</th>
            <th style="width:120px;">ƒê∆°n gi√° (‚Ç´)</th>
            <th style="width:110px;">ƒê∆°n v·ªã</th>
            <th style="width:130px;">H·∫°n s·ª≠ d·ª•ng</th>
            <th style="width:140px;">V·ªã tr√≠</th>
            <th style="width:160px;">Th√†nh ti·ªÅn (‚Ç´)</th>
            <th style="width:60px;">X√≥a</th>
          </tr>
        </thead>
        <tbody id="item-body">
          {% for f in formset.forms %}
          <tr class="item-row align-middle">
            <!-- ·∫®n tr∆∞·ªùng ASN item nh∆∞ng v·∫´n submit -->
            <td class="d-none">
              {{ f.asn_item }}
            </td>

            <td>
              {{ f.product }}
              {% if f.product.errors %}
                <div class="text-danger small">{{ f.product.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.quantity }}
              {% if f.quantity.errors %}
                <div class="text-danger small">{{ f.quantity.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.unit_price }}
              {% if f.unit_price.errors %}
                <div class="text-danger small">{{ f.unit_price.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.unit }}
              {% if f.unit.errors %}
                <div class="text-danger small">{{ f.unit.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.expiry_date }}
              {% if f.expiry_date.errors %}
                <div class="text-danger small">{{ f.expiry_date.errors }}</div>
              {% endif %}
            </td>

            <td>
              {{ f.location }}
              {% if f.location.errors %}
                <div class="text-danger small">{{ f.location.errors }}</div>
              {% endif %}
            </td>

            <td class="text-end total-cell text-primary fw-semibold">0</td>

            <td class="text-center">
              {% if formset.can_delete %}
                {{ f.DELETE }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>

        <tfoot class="table-light fw-semibold">
          <tr>
            <td colspan="7" class="text-end">T·ªïng c·ªông:</td>
            <td class="text-end text-primary fs-6" id="grand-total">0 ‚Ç´</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- N√∫t h√†nh ƒë·ªông -->
    <div class="text-end mt-4">
      <a href="{% url 'import_list' %}" class="btn btn-secondary">
        <i class="fa-solid fa-xmark me-1"></i> H·ªßy
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-save me-1"></i> L∆∞u phi·∫øu nh·∫≠p
      </button>
    </div>
  </form>
</div>

<style>
.table th, .table td { vertical-align: middle !important; }
.table th { font-weight: 600; }
.table input, .table select { height: 36px; font-size: 14px; }
.item-row td { vertical-align: middle !important; }
td label { display: none; }
.total-cell { font-weight: 600; color: #0d6efd; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const asnSelect = document.getElementById("id_asn");
  const grandTotalCell = document.getElementById("grand-total");

  // üîÅ Khi ƒë·ªïi ASN ‚Üí reload trang v·ªõi ?asn=...
  if (asnSelect) {
    asnSelect.addEventListener("change", function() {
      const value = this.value;
      const url = new URL(window.location.href);
      if (value) {
        url.searchParams.set("asn", value);
      } else {
        url.searchParams.delete("asn");
      }
      window.location.href = url.toString();
    });
  }

  // G·∫Øn class ƒë·ªÉ t√≠nh t·ªïng
  document.querySelectorAll('input[name$="-quantity"]').forEach(i => i.classList.add("quantity"));
  document.querySelectorAll('input[name$="-unit_price"]').forEach(i => {
    i.classList.add("unit-price");

    // ‚úÖ B·ªè .00: convert v·ªÅ s·ªë nguy√™n n·∫øu c√≥ gi√° tr·ªã
    if (i.value) {
      const v = parseFloat(i.value);
      if (!isNaN(v)) {
        i.value = parseInt(v);
      }
    }
    // ‚úÖ Ch·ªâ cho nh·∫≠p b∆∞·ªõc 1 (kh√¥ng s·ªë l·∫ª)
    i.step = "1";
  });

  function calculateTotals() {
    let grand = 0;
    document.querySelectorAll(".item-row").forEach(row => {
      const qty = parseFloat(row.querySelector(".quantity")?.value || 0);
      const price = parseFloat(row.querySelector(".unit-price")?.value || 0);
      const total = qty * price;
      const cell = row.querySelector(".total-cell");
      if (cell) {
        cell.textContent = total ? total.toLocaleString("vi-VN") + " ‚Ç´" : "0 ‚Ç´";
      }
      grand += total;
    });
    if (grandTotalCell) {
      grandTotalCell.textContent = grand.toLocaleString("vi-VN") + " ‚Ç´";
    }
  }

  document.querySelectorAll(".quantity, .unit-price").forEach(i => {
    i.addEventListener("input", calculateTotals);
  });

  setTimeout(calculateTotals, 200);
});
</script>
{% endblock %}
