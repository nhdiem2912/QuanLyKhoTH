{% extends "base.html" %}
{% block title %}Thêm sản phẩm kinh doanh{% endblock %}
{% block page_title %}Thêm sản phẩm kinh doanh{% endblock %}

{% block extra_head %}
<style>
    .hero-card {
        border-radius: 16px;
        background: linear-gradient(135deg, #0d6efd, #38bdf8);
        color: #fff;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    .hero-icon {
        width: 44px; height: 44px; border-radius: 999px;
        background: rgba(255,255,255,0.18);
        display: flex; justify-content: center; align-items: center;
        font-size: 22px;
    }
    label { font-weight: 600; margin-bottom: 4px; }
    .section-title {
        font-size: 17px; font-weight: 600; color: #0d6efd;
        margin-bottom: 14px;
    }
    .thumb {
        width: 80px; height: 80px; border-radius: 12px;
        background: #f3f4f6; overflow: hidden;
    }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .table td, .table th { vertical-align: middle !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- HERO -->
    <div class="hero-card shadow-sm">
        <div>
            <h5>Thêm sản phẩm kinh doanh</h5>
            <p>Khai báo sản phẩm & gán nhà cung ứng cung cấp.</p>
        </div>
        <div class="hero-icon"><i class="fa-solid fa-box"></i></div>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- THÔNG TIN SẢN PHẨM -->
        <div class="card p-4 shadow-sm mb-4">
            <div class="section-title">Thông tin sản phẩm</div>

            <div class="row g-3">

                <div class="col-md-4">
                    <label>{{ form.product_code.label }}</label>
                    {{ form.product_code }}
                    <div class="text-danger small">{{ form.product_code.errors }}</div>
                </div>

                <div class="col-md-8">
                    <label>{{ form.name.label }}</label>
                    {{ form.name }}
                    <div class="text-danger small">{{ form.name.errors }}</div>
                </div>

                <div class="col-md-4">
                    <label>{{ form.category.label }}</label>
                    {{ form.category }}
                    <div class="text-danger small">{{ form.category.errors }}</div>
                </div>

                <div class="col-md-4">
                    <label>{{ form.status.label }}</label>
                    {{ form.status }}
                    <div class="text-danger small">{{ form.status.errors }}</div>
                </div>

                <div class="col-md-4">
                    <label>{{ form.image.label }}</label>
                    {{ form.image }}
                    <div class="text-danger small">{{ form.image.errors }}</div>
                </div>

            </div>
        </div>

        <!-- FORMSET NHÀ CUNG ỨNG -->
        <div class="card p-4 shadow-sm mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="section-title mb-0">Nhà cung ứng cung cấp sản phẩm</span>

                <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-plus me-1"></i> Thêm nhà cung ứng
                </button>
            </div>

            {{ formset.management_form }}

            <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th style="width:40%">Nhà cung ứng</th>
                        <th style="width:30%">Đơn giá NCC (₫)</th>
                        <th style="width:15%">Xóa</th>
                    </tr>
                </thead>
                <tbody id="formset-body">
                    {% for f in formset.forms %}
                    <tr>
                        <td>{{ f.supplier }}</td>
                        <td>{{ f.unit_price }}</td>
                        <td>{% if formset.can_delete %}{{ f.DELETE }}{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <small class="text-muted fst-italic">
                * Một sản phẩm có thể được cung cấp bởi nhiều nhà cung ứng khác nhau.
            </small>
        </div>

        <div class="text-end">
            <a href="{% url 'product_master_list' %}" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left-long me-1"></i> Hủy
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-floppy-disk me-1"></i> Lưu sản phẩm
            </button>
        </div>

    </form>
</div>

<!-- SCRIPT THÊM DÒNG -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const addButton = document.getElementById("add-row");
    const totalForms = document.querySelector("#id_supplierproduct_set-TOTAL_FORMS");
    const tbody = document.getElementById("formset-body");

    if (!addButton || !totalForms || !tbody) return;

    addButton.addEventListener("click", function() {
        let idx = parseInt(totalForms.value);
        let templateRow = tbody.querySelector("tr");

        if (!templateRow) return;

        let newRow = templateRow.cloneNode(true);

        newRow.innerHTML = newRow.innerHTML.replace(/supplierproduct_set-\d+/g, `supplierproduct_set-${idx}`);

        newRow.querySelectorAll("input, select").forEach(el => el.value = "");

        tbody.appendChild(newRow);
        totalForms.value = idx + 1;
    });
});
</script>

{% endblock %}
