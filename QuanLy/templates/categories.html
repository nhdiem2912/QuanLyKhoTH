{% extends "base.html" %}
{% block title %}Danh mục - TH True Mart{% endblock %}
{% block page_title %}Danh mục{% endblock %}
{% load humanize %}
{# CSS riêng cho trang danh mục #}
{% block extra_head %}
<style>
  .category-card {
    transition: box-shadow 0.15s ease, transform 0.15s ease;
    border: 1px solid #e5e7eb;
  }
  .category-card:hover {
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    transform: translateY(-2px);
  }
  .category-thumb {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    overflow: hidden;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .category-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;

  }
    .hero-card {
    border-radius: 16px;
    background: linear-gradient(135deg, #0d6efd, #38bdf8);
    color: #fff;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
    margin-bottom: 18px;
  }
  .hero-card h5 {
    margin: 0 0 4px;
    font-weight: 600;
  }
  .hero-card p {
    margin: 0;
    font-size: 14px;
    opacity: 0.92;
  }
  .hero-icon {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="hero-card">
  <div>
    <h5>Quản lý danh mục sản phẩm</h5>
    <p>Tạo, chỉnh sửa và sắp xếp các nhóm sản phẩm trong hệ thống.</p>
  </div>
  <div class="d-flex align-items-center gap-2">
    <a href="{% url 'add_category' %}" class="btn btn-light btn-sm text-primary fw-semibold">
      <i class="fa-solid fa-plus me-1"></i> Thêm danh mục
    </a>
  </div>
</div>



<!-- Bộ lọc & tìm kiếm -->
<form method="get" class="row g-3 mb-4 bg-white p-3 rounded-3 shadow-sm">
  <div class="col-md-4">
    <input type="text" name="q" class="form-control"
           placeholder="Tìm theo tên, mã, mô tả…" value="{{ q }}">
  </div>

  <div class="col-md-2">
    <button class="btn btn-primary w-100">
      <i class="fa-solid fa-filter me-1"></i> Lọc
    </button>
  </div>

  <div class="col-md-2">
    <a href="{% url 'categories' %}" class="btn btn-secondary w-100">
      <i class="fa-solid fa-rotate-left me-1"></i> Reset
    </a>
  </div>
</form>


<form id="csrf-token-form" style="display:none;">
  {% csrf_token %}
</form>

<div class="row g-3">
  {% if categories %}
    {% for c in categories %}
      <div class="col-md-6 col-xl-4">
        <div class="bg-white p-3 rounded-3 shadow-sm h-100 category-card">
          <div class="d-flex justify-content-between">
            <div class="d-flex align-items-center gap-3">
              <div class="category-thumb">
                {% if c.image %}
                  <img src="{{ c.image.url }}" alt="{{ c.name }}">
                {% else %}
                  <i class="fa-solid fa-bag-shopping text-muted"></i>
                {% endif %}
              </div>
              <div>
                <div class="fw-bold">{{ c.name }}</div>
                <div class="text-muted small mb-1">
                  {{ c.description|default:"Không có mô tả" }}
                </div>

                <div class="text-muted small">
                  {{ c.products_from_imports|length }} sản phẩm
                </div>
              </div>
            </div>
            <span class="text-muted small">{{ c.category_code }}</span>
          </div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <div>
              <button class="btn btn-outline-primary btn-sm me-2"
                      data-bs-toggle="modal"
                      data-bs-target="#categoryDetail{{ c.category_code }}"
                      title="Xem chi tiết">
                <i class="fa-solid fa-eye"></i> Xem chi tiết
              </button>
              <a href="{% url 'edit_category' c.category_code %}" class="text-primary me-3" title="Chỉnh sửa">
                <i class="fa-solid fa-pen"></i> Sửa
              </a>
              <a href="#" class="text-danger btn-delete-category"
                 data-id="{{ c.category_code }}"
                 data-name="{{ c.name }}"
                 data-url="{% url 'delete_category' c.category_code %}"
                 title="Xóa">
                <i class="fa-solid fa-trash"></i> Xóa
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <div class="text-center text-muted py-5 bg-white rounded-3 shadow-sm">
        <i class="fa-regular fa-rectangle-list fa-2x mb-3"></i>
        <div>Chưa có danh mục nào</div>
        <a href="{% url 'add_category' %}" class="btn btn-success mt-2">
          <i class="fa-solid fa-plus me-1"></i> Thêm danh mục
        </a>
      </div>
    </div>
  {% endif %}
</div>

<!-- MODAL CHI TIẾT DANH MỤC - CHỈ HIỂN THỊ KHI BẤM XEM CHI TIẾT -->
{% for c in categories %}
<div class="modal fade" id="categoryDetail{{ c.category_code }}" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold">
          Chi tiết danh mục – {{ c.category_code }} | {{ c.name }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <h6 class="fw-semibold text-primary mb-3">Thông tin chung</h6>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Mã danh mục:</strong> {{ c.category_code }}</div>
          <div class="col-md-6"><strong>Tên danh mục:</strong> {{ c.name }}</div>
          <div class="col-12 mt-2"><strong>Mô tả:</strong> {{ c.description|default:"Không có mô tả" }}</div>
        </div>

        <hr>

        {# YÊU CẦU: Danh sách sản phẩm từ phiếu nhập #}
        <h6 class="fw-semibold text-primary mb-3">Sản phẩm đã nhập kho trong danh mục này</h6>
        {% if c.products_from_imports %}
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-bordered table-hover text-center">
            <thead class="table-light">
              <tr>
                <th style="width:20%">Mã SP</th>
                <th class="text-start" style="width:50%">Tên sản phẩm</th>
                <th class="text-end" style="width:30%">Đơn giá (₫)</th>
              </tr>
            </thead>
            <tbody>
              {% for p in c.products_from_imports %}
              <tr>
                <td class="fw-semibold">{{ p.product_code }}</td>
                <td class="text-start">{{ p.name }}</td>
                <td class="text-end fw-semibold text-primary">{{ p.unit_price|floatformat:0|intcomma }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0">
          <i class="fa-solid fa-info-circle me-2"></i>
          Chưa có sản phẩm nào được nhập kho trong danh mục này.
        </div>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}


<script>
document.addEventListener("DOMContentLoaded", () => {
  const getCSRFToken = () =>
    document.querySelector("#csrf-token-form [name=csrfmiddlewaretoken]").value;

  document.querySelectorAll(".btn-delete-category").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const url = btn.dataset.url;
      const name = btn.dataset.name;

      if (!url) {
        alert("Không tìm thấy URL xoá danh mục.");
        return;
      }

      if (confirm(`Bạn có chắc muốn xóa danh mục "${name}" không?`)) {
        fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCSRFToken(),
            "X-Requested-With": "XMLHttpRequest"
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            location.reload();
          } else {
            alert("❌ Không thể xóa danh mục!");
          }
        })
        .catch(() => alert("⚠️ Lỗi máy chủ!"));
      }
    });
  });
});
</script>

{% endblock %}
