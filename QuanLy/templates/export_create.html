{% extends "base.html" %}
{% load humanize %}
{% block title %}Tạo phiếu xuất - TH True Mart{% endblock %}
{% block page_title %}Tạo phiếu xuất kho{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="bg-white p-3 rounded-3 shadow-sm mb-4">
    <h5 class="fw-semibold text-primary mb-1">Tạo phiếu xuất kho</h5>
    <small class="text-muted">Nhập thông tin phiếu và danh sách hàng xuất</small>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    <div class="card p-3 mb-4 shadow-sm">
      <h6 class="fw-semibold text-primary mb-2">Thông tin phiếu xuất</h6>
      <div class="row g-3">
        <div class="col-md-3">{{ form.export_code.label_tag }}{{ form.export_code }}</div>
        <div class="col-md-3">{{ form.export_date.label_tag }}{{ form.export_date }}</div>
        <div class="col-md-4">{{ form.destination.label_tag }}{{ form.destination }}</div>
        <div class="col-md-12">{{ form.note.label_tag }}{{ form.note }}</div>
      </div>
    </div>

    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold text-primary mb-0">Danh sách hàng xuất</h6>
        <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
          <i class="fa-solid fa-plus me-1"></i> Thêm dòng
        </button>
      </div>

      {{ formset.management_form }}

      <table class="table table-bordered align-middle text-center" id="export-table">
        <thead class="table-primary">
          <tr>
            <th>Lô hàng (StockItem)</th>
            <th style="width:90px;">Số lượng</th>
            <th style="width:130px;">Đơn giá (₫)</th>
            <th style="width:120px;">Chiết khấu (%)</th>
            <th style="width:120px;">Đơn vị</th>
            <th style="width:150px;">Thành tiền (₫)</th>
            <th style="width:60px;">Xóa</th>
          </tr>
        </thead>

        <tbody id="item-body">
          {% for f in formset.forms %}
          <tr class="item-row align-middle">

            <!-- ⚡⚡⚡ FIELD STOCK_ITEM (ĐÃ SỬA CHUẨN) -->
            <td>
              {{ f.stock_item.errors }}
              <select name="items-{{ forloop.counter0 }}-stock_item"
                      id="id_items-{{ forloop.counter0 }}-stock_item"
                      class="form-select stock-select">

                  <option value="">-- Chọn lô hàng --</option>

                  {% for s in f.fields.stock_item.queryset %}
                      <option value="{{ s.pk }}"
                              data-quantity="{{ s.quantity }}"
                              {% if f.stock_item.value == s.pk %}selected{% endif %}>

                          {{ s.product.name }}

                          {% if s.import_receipt %}
                            ({{ s.import_receipt.import_code }})
                          {% elif s.return_receipt %}
                            ({{ s.return_receipt.return_code }})
                          {% endif %}

                          - SL: {{ s.quantity }}
                          - HSD: {{ s.expiry_date|date:"d/m/Y" }}
                          [{{ s.get_status_display }}]
                      </option>
                  {% endfor %}
              </select>
            </td>

            <td>{{ f.quantity }}</td>
            <td>{{ f.unit_price }}</td>
            <td>{{ f.discount_percent }}</td>
            <td>{{ f.unit }}</td>
            <td class="text-end total-cell text-primary fw-semibold">0</td>
            <td>{{ f.DELETE }}</td>
          </tr>
          {% endfor %}
        </tbody>

        <tfoot class="table-light fw-semibold">
          <tr>
            <td colspan="5" class="text-end">Tổng chiết khấu:</td>
            <td class="text-end text-danger" id="discount-total">0 ₫</td>
            <td></td>
          </tr>
          <tr>
            <td colspan="5" class="text-end">Tổng cộng sau giảm:</td>
            <td class="text-end text-primary fs-6" id="grand-total">0 ₫</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="text-end mt-4">
      <a href="{% url 'export_list' %}" class="btn btn-secondary">
        <i class="fa-solid fa-xmark me-1"></i> Hủy
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-save me-1"></i> Lưu phiếu xuất
      </button>
    </div>
  </form>
</div>

<style>
.table th, .table td { vertical-align: middle !important; }
.total-cell { font-weight: 600; color: #0d6efd; }
#discount-total { color: #dc3545; font-weight: 600; }
#grand-total { color: #0d6efd; font-weight: 700; font-size: 15px; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {

  const addButton = document.getElementById("add-row");
  const totalForms = document.getElementById("id_items-TOTAL_FORMS");
  const tbody = document.getElementById("item-body");
  const templateHTML = tbody.querySelector("tr").outerHTML;

  function attachEvents(row) {
      row.querySelectorAll("input").forEach(el => {
          el.addEventListener("input", calcAll);
      });
      const sel = row.querySelector(".stock-select");
      if (sel) sel.addEventListener("change", calcAll);
  }

  function calcAll() {
      let baseSum = 0, discountedSum = 0;

      document.querySelectorAll(".item-row").forEach(row => {
          const qty = parseFloat(row.querySelector('[name$="quantity"]').value || 0);
          const price = parseFloat(row.querySelector('[name$="unit_price"]').value || 0);
          const discount = parseFloat(row.querySelector('[name$="discount_percent"]').value || 0);
          const cell = row.querySelector(".total-cell");
          const base = qty * price;
          const total = base * (1 - discount / 100);
          baseSum += base;
          discountedSum += total;
          cell.textContent = total.toLocaleString("vi-VN");
      });

      document.getElementById("discount-total").textContent =
          (baseSum - discountedSum).toLocaleString("vi-VN") + " ₫";

      document.getElementById("grand-total").textContent =
          discountedSum.toLocaleString("vi-VN") + " ₫";
  }

  document.querySelectorAll(".item-row").forEach(r => attachEvents(r));
  calcAll();
});
</script>

{% endblock %}
