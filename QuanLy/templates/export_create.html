    {% extends "base.html" %}
    {% load humanize %}

    {% block title %}Tạo phiếu xuất - TH True Mart{% endblock %}
    {% block page_title %}Tạo phiếu xuất kho{% endblock %}

    {% block content %}
    <div class="container-fluid">

      <!-- HEADER -->
      <div class="bg-white p-3 rounded-3 shadow-sm mb-4">
        <h5 class="fw-semibold text-primary mb-1">Tạo phiếu xuất kho</h5>
        <small class="text-muted">Nhập thông tin phiếu và danh sách hàng xuất khỏi kho</small>
      </div>

      <form method="post" novalidate>
        {% csrf_token %}

        <!-- ================= THÔNG TIN PHIẾU XUẤT ================= -->
        <div class="card p-3 mb-4 shadow-sm">
          <h6 class="fw-semibold text-primary mb-2">Thông tin phiếu xuất</h6>

          <div class="row g-3">
            <div class="col-md-3">
              {{ form.export_code.label_tag }}
              {{ form.export_code }}
            </div>

            <div class="col-md-3">
              {{ form.export_date.label_tag }}
              {{ form.export_date }}
            </div>

            <div class="col-md-3">
              {{ form.destination.label_tag }}
              {{ form.destination }}
            </div>

            <div class="col-md-3">
              {{ form.receiver_name.label_tag }}
              {{ form.receiver_name }}
            </div>

            <div class="col-md-3">
              {{ form.receiver_phone.label_tag }}
              {{ form.receiver_phone }}
            </div>

            <div class="col-md-9">
              {{ form.note.label_tag }}
              {{ form.note }}
            </div>
          </div>

          <small class="text-muted d-block mt-2">
            * Đơn giá được tự động lấy từ <strong>giá nhập của lô hàng</strong>.
          </small>
        </div>

        <!-- ================= DANH SÁCH HÀNG XUẤT ================= -->
        <div class="card p-3 shadow-sm">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-semibold text-primary mb-0">Danh sách hàng xuất</h6>
            <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
              <i class="fa-solid fa-plus me-1"></i> Thêm dòng
            </button>
          </div>

          {{ formset.management_form }}

          <table class="table table-bordered align-middle text-center" id="export-table">
            <thead class="table-primary">
              <tr>
                <th style="width:32%">Lô hàng (FEFO – Cận hạn ưu tiên)</th>
                <th style="width:10%">SL</th>
                <th style="width:14%">Đơn giá</th>
                <th style="width:12%">CK (%)</th>
                <th style="width:12%">Đơn vị</th>
                <th style="width:14%">Thành tiền</th>
                <th style="width:6%">Xóa</th>
              </tr>
            </thead>

            <tbody id="item-body">
              {% for f in formset.forms %}
              <tr class="item-row">

                <!-- LÔ HÀNG + SEARCH -->
                <td>
                  <input type="text"
                         class="form-control form-control-sm stock-search mb-1"
                         placeholder="Tìm sản phẩm...">

                  <select name="{{ f.stock_item.html_name }}" class="form-select stock-select">
                    <option value="">--------</option>

                    {% for s in stock_queryset %}
                    <option value="{{ s.pk }}"
                            data-text="{{ s.product.name|lower }}"
                            data-quantity="{{ s.quantity }}"
                            data-unit-price="{{ s.unit_price }}"
                            data-display-price="{{ s.unit_price}}"
                            data-unit="{{ s.unit }}"
                            data-status="{{ s.status }}"
                            data-expiry="{{ s.expiry_date|date:'Y-m-d' }}"
                            {% if f.stock_item.value == s.pk %}selected{% endif %}>

                      {{ s.product.name }}
                      - SL: {{ s.quantity }}
                      {% if s.expiry_date %}- HSD: {{ s.expiry_date|date:"d/m/Y" }}{% endif %}
                      [{{ s.get_status_display }}]
                    </option>
                    {% endfor %}
                  </select>
                </td>

                <!-- SỐ LƯỢNG -->
                <td>
                  <input type="number"
                         name="{{ f.quantity.html_name }}"
                         class="form-control text-end quantity"
                         min="1"
                         value="{{ f.quantity.value|default:0 }}">
                </td>

                <!-- ĐƠN GIÁ (KHÔNG THẬP PHÂN) -->
                <td>
                  <input type="text"
                         name="{{ f.unit_price.html_name }}"
                         class="form-control text-end unit-price"
                         readonly
                         value="{{ f.unit_price.value|floatformat:'0' }}">
                </td>

                <!-- CHIẾT KHẤU -->
                <td>
                  <input type="number"
                         name="{{ f.discount_percent.html_name }}"
                         class="form-control text-end discount"
                         min="0" step="0.01"
                         value="{{ f.discount_percent.value|default:0 }}">
                </td>

                <!-- ĐƠN VỊ -->
                <td>
                  <input type="text"
                         name="{{ f.unit.html_name }}"
                         class="form-control unit-field"
                         readonly
                         value="{{ f.unit.value|default:'' }}">
                </td>

                <!-- THÀNH TIỀN -->
                <td class="text-end total-cell text-primary fw-semibold">
                  0 ₫
                </td>

                <input type="hidden"
                       name="{{ f.total.html_name }}"
                       class="total-input"
                       value="0">

                <!-- DELETE -->
                <td class="text-center">
                  {{ f.DELETE }}
                </td>

              </tr>
              {% endfor %}
            </tbody>

            <tfoot class="table-light fw-semibold">
              <tr>
                <td colspan="5" class="text-end">Tổng chiết khấu:</td>
                <td class="text-end text-danger" id="discount-total">0 ₫</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="5" class="text-end">Tổng cộng sau giảm:</td>
                <td class="text-end text-primary fs-6" id="grand-total">0 ₫</td>
                <td></td>
              </tr>
            </tfoot>

          </table>
        </div>

        <!-- NÚT HÀNH ĐỘNG -->
        <div class="text-end mt-4">
          <a href="{% url 'export_list' %}" class="btn btn-secondary">
            <i class="fa-solid fa-xmark me-1"></i> Hủy
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-save me-1"></i> Lưu phiếu xuất
          </button>
        </div>

      </form>
    </div>

    <!-- TEMPLATE FORMSET ROW ẨN -->
    <table class="d-none">
      <tbody id="empty-form-template">
        {% include 'export_item_empty_row.html' %}
      </tbody>
    </table>

    <style>
      .table th, .table td { vertical-align: middle !important; }
      .stock-select option[data-status="nearly_expired"] { background-color: #fff3cd !important; }
      .stock-select option[data-status="expired"] {
        background-color: #f8d7da !important;
        color: #b20000 !important;
      }
      .stock-select option[data-status="valid"] { background-color: #d1e7dd !important; }

      .stock-select { max-height: 180px; overflow-y: auto; }
      .stock-search { width: 100%; padding: 4px 6px; }
      .total-cell { font-weight: 600; }
    </style>

   <script>
document.addEventListener("DOMContentLoaded", function () {

  // Ngăn Enter trong ô search làm submit form
  document.addEventListener("keydown", function(e) {
    if (e.target.classList.contains("stock-search") && e.key === "Enter") {
      e.preventDefault();
    }
  });

  // ================== SEARCH FILTER ==================
  document.addEventListener("input", function(e) {
    if (!e.target.classList.contains("stock-search")) return;

    const keyword = (e.target.value || "").toLowerCase();
    const select = e.target.parentElement.querySelector(".stock-select");
    if (!select) return;

    for (let opt of select.options) {
      if (!opt.value) continue;
      const text = (opt.dataset.text || "").toLowerCase();
      opt.hidden = !text.includes(keyword);
    }
  });

  // ================== GẮN EVENT CHO 1 DÒNG ==================
  function attachEvents(row) {
    const stock      = row.querySelector(".stock-select");
    const qtyInput   = row.querySelector(".quantity");
    const priceInput = row.querySelector(".unit-price");
    const unitField  = row.querySelector(".unit-field");

    if (stock) {
      stock.addEventListener("change", function () {
        const opt = stock.options[stock.selectedIndex];
        if (!opt || !opt.value) {
          priceInput.value = "";
          priceInput.dataset.rawPrice = "0";
          unitField.value = "";
          if (qtyInput) qtyInput.value = "0";
          calcAll();
          return;
        }

        // GIÁ GỐC LẤY TỪ OPTION (ví dụ 8.5) – KHÔNG LÀM TRÒN
        const basePrice = parseFloat(opt.dataset.unitPrice || "0") || 0;

        // GIÁ DÙNG ĐỂ TÍNH (THÊM 3 SỐ 0): 8.5  →  8500
        const rawPrice = basePrice * 1000;

        // Lưu lại để calcAll dùng
        priceInput.dataset.rawPrice = rawPrice.toString();

        // Hiển thị đơn giá **KHÔNG DẤU CHẤM**, ví dụ "8500"
        priceInput.value = rawPrice.toString();

        // ĐƠN VỊ
        unitField.value = opt.dataset.unit || "";

        // GIỚI HẠN SỐ LƯỢNG
        if (qtyInput) {
          qtyInput.max = opt.dataset.quantity || "";
          if (!qtyInput.value || qtyInput.value === "0") {
            qtyInput.value = 1;
          }
        }

        calcAll();
      });
    }

    // mọi input thay đổi → tính lại
    row.querySelectorAll("input").forEach(i => {
      i.addEventListener("input", calcAll);
    });
  }

  // ================== TÍNH TỔNG ==================
  function calcAll() {
    let base = 0, discountSum = 0;

    document.querySelectorAll(".item-row").forEach(row => {
      const qtyEl       = row.querySelector(".quantity");
      const discountEl  = row.querySelector(".discount");
      const priceEl     = row.querySelector(".unit-price");
      const totalCell   = row.querySelector(".total-cell");
      const totalHidden = row.querySelector(".total-input");

      if (!qtyEl || !priceEl || !discountEl || !totalCell || !totalHidden) return;

      const qty      = parseFloat(qtyEl.value || "0") || 0;
      const discount = parseFloat(discountEl.value || "0") || 0;

      // LẤY GIÁ DÙNG ĐỂ TÍNH (ĐÃ NHÂN 1000 Ở BƯỚC CHANGE)
      let rawPrice = 0;
      if (priceEl.dataset.rawPrice !== undefined) {
        rawPrice = parseFloat(priceEl.dataset.rawPrice || "0") || 0;
      } else {
        // Trường hợp hiếm: chưa có dataset.rawPrice → đọc từ value
        // Nếu value đang là 8.5 thì cũng nhân 1000 để có 8500
        const clean = (priceEl.value || "0").replace(/[^\d.\-]/g, "");
        const basePrice = parseFloat(clean || "0") || 0;
        rawPrice = basePrice * 1000;
      }

      // TÍNH THEO ĐƠN GIÁ ĐÃ CÓ 3 SỐ 0
      const lineBase  = qty * rawPrice;
      const lineTotal = lineBase * (1 - discount / 100);

      totalCell.textContent = lineTotal
        ? lineTotal.toLocaleString("vi-VN") + " ₫"
        : "0 ₫";
      totalHidden.value = lineTotal.toFixed(0);

      base        += lineBase;
      discountSum += (lineBase - lineTotal);
    });

    document.getElementById("discount-total").textContent =
      discountSum.toLocaleString("vi-VN") + " ₫";

    document.getElementById("grand-total").textContent =
      (base - discountSum).toLocaleString("vi-VN") + " ₫";
  }

  // GẮN EVENT CHO CÁC DÒNG BAN ĐẦU
  document.querySelectorAll(".item-row").forEach(r => attachEvents(r));
  calcAll();

  // ================== THÊM DÒNG MỚI ==================
  const addRowBtn  = document.getElementById("add-row");
  const totalForms = document.getElementById("id_items-TOTAL_FORMS");
  const tmplRow    = document.querySelector("#empty-form-template tr");

  if (addRowBtn && totalForms && tmplRow) {
    addRowBtn.addEventListener("click", function () {
      const index = parseInt(totalForms.value || "0");
      const newRow = tmplRow.cloneNode(true);

      newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, index);
      document.getElementById("item-body").appendChild(newRow);

      attachEvents(newRow);
      calcAll();

      totalForms.value = index + 1;
    });
  }

});
</script>


    {% endblock %}
