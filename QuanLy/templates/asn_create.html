{% extends "base.html" %}
{% load humanize %}
{% block title %}Tạo phiếu giao hàng (ASN) - TH True Mart{% endblock %}
{% block page_title %}Tạo phiếu giao hàng (ASN){% endblock %}

{% block extra_head %}
<style>
  .hero-card {
    border-radius: 16px;
    background: linear-gradient(135deg, #0d6efd, #38bdf8);
    color: #fff;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
    margin-bottom: 18px;
  }
  .hero-card h5 {
    margin: 0 0 4px;
    font-weight: 600;
  }
  .hero-card p {
    margin: 0;
    font-size: 14px;
    opacity: 0.92;
  }
  .hero-icon {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  .table th, .table td {
    vertical-align: middle !important;
  }
  .table input, .table select {
    height: 38px;
    font-size: 14px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- HERO -->
  <div class="hero-card">
    <div>
      <h5>Tạo phiếu giao hàng (ASN)</h5>
      <p>Liên kết với PO, kiểm soát số lượng giao ≤ số lượng đặt.</p>
    </div>
    <div class="hero-icon">
      <i class="fa-solid fa-truck"></i>
    </div>
  </div>

  <!-- THÔNG BÁO LỖI FORM CHUNG -->
  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {{ form.non_field_errors }}
    </div>
  {% endif %}
  {% if formset.non_field_errors %}
    <div class="alert alert-danger">
      {{ formset.non_field_errors }}
    </div>
  {% endif %}

  <form method="post" id="asnForm">
    {% csrf_token %}

    <!-- Thông tin chung -->
    <div class="card p-3 mb-3 shadow-sm">
      <h6 class="fw-semibold text-primary mb-3">Thông tin phiếu giao hàng</h6>
      <div class="row g-3">
        <div class="col-md-3">
          {{ form.asn_code.label_tag }}
          {{ form.asn_code }}
          {{ form.asn_code.errors }}
        </div>

        <div class="col-md-3">
          {{ form.po.label_tag }}
          <select name="po" id="id_po" class="form-select">
              <option value="">---------</option>
              {% for p in allowed_po %}
                  <option value="{{ p.pk }}"
                    {% if form.initial.po and form.initial.po.pk == p.pk %}selected{% endif %}>
                      {{ p.po_code }} — {{ p.supplier.company_name }}
                  </option>
              {% endfor %}
          </select>
          {% if form.po.errors %}
              <div class="text-danger small">{{ form.po.errors }}</div>
          {% endif %}

        </div>


        <div class="col-md-3">
          {{ form.expected_date.label_tag }}
          {{ form.expected_date }}
          {{ form.expected_date.errors }}
        </div>

        <div class="col-md-3">
          {{ form.deliverer_name.label_tag }}
          {{ form.deliverer_name }}
          {{ form.deliverer_name.errors }}
        </div>
        <div class="col-md-3">
          {{ form.deliverer_phone.label_tag }}
          {{ form.deliverer_phone }}
          {{ form.deliverer_phone.errors }}
        </div>
        <div class="col-md-3">
          {{ form.status.label_tag }}
          {{ form.status }}
          {{ form.status.errors }}
        </div>
        <div class="col-md-3">
          {{ form.note.label_tag }}
          {{ form.note }}
          {{ form.note.errors }}
        </div>
      </div>
    </div>

    <!-- Danh sách sản phẩm -->
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold text-primary mb-0">Danh sách sản phẩm giao</h6>
        <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
          <i class="fa-solid fa-plus me-1"></i> Thêm dòng
        </button>
      </div>

      {{ formset.management_form }}
      <table class="table table-bordered align-middle text-center mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 25%">Sản phẩm</th>
            <th style="width: 10%">Số lượng</th>
            <th style="width: 10%">Đơn vị</th>
            <th style="width: 15%">Đơn giá (₫)</th>
            <th style="width: 15%">Thành tiền (₫)</th>
            <th style="width: 15%">Hạn sử dụng</th>
            <th style="width: 5%">Xóa</th>
          </tr>
        </thead>
        <tbody id="item-body">
          {% for f in formset.forms %}
          <tr class="align-middle">
            <td>
              {{ f.product }}
              {{ f.product.errors }}

            </td>
            <td>
              {{ f.quantity }}
              {{ f.quantity.errors }}

            </td>
            <td>
              {{ f.unit }}
              {{ f.unit.errors }}
            </td>
            <td>
              {{ f.unit_price }}
              {{ f.unit_price.errors }}

            </td>
            <td class="text-end fw-semibold text-primary">
              <span class="line-total">0 ₫</span>
            </td>
            <td>
              {{ f.expiry_date }}
              {{ f.expiry_date.errors }}
            </td>
            <td>
              {% if formset.can_delete %}
                {{ f.DELETE }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light fw-semibold">
          <tr>
            <td colspan="4" class="text-end">Tổng cộng:</td>
            <td class="text-end text-primary fs-5" id="grand-total">0 ₫</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="text-end mt-3">
      <a href="{% url 'asn_list' %}" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left-long me-1"></i> Quay lại
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-floppy-disk me-1"></i> Lưu phiếu giao hàng
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const addButton = document.getElementById("add-row");
  const totalForms = document.getElementById("id_items-TOTAL_FORMS");
  const tbody = document.getElementById("item-body");
  const poSelect = document.getElementById("id_po");
  const grandTotalCell = document.getElementById("grand-total");
  const asnForm = document.getElementById("asnForm");

  if (!tbody) return;
  const firstRow = tbody.querySelector("tr");
  if (!firstRow) return;

  let poProducts = {}; // Sản phẩm và số lượng trong PO

  // Gắn class product-select cho tất cả select product (không cần add_class)
  tbody.querySelectorAll('select[name$="-product"]').forEach(sel => {
    sel.classList.add('product-select');
  });

  // Khi chọn PO, tự động set nhà cung cấp và filter sản phẩm
  if (poSelect) {
    poSelect.addEventListener("change", function() {
      const poId = this.value;
      if (!poId) {
        tbody.querySelectorAll('.product-select').forEach(select => {
          select.innerHTML = '<option value="">-- Chọn PO trước --</option>';
        });
        return;
      }

      // Fetch thông tin PO
      fetch(`/api/po-details/${poId}/`)
        .then(res => res.json())
        .then(data => {
          poProducts = data.products || {};

          // Cập nhật select sản phẩm
          tbody.querySelectorAll('.product-select').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';
            Object.keys(poProducts).forEach(productId => {
              const product = poProducts[productId];
              const option = document.createElement('option');
              option.value = productId;
              option.textContent = `${product.code} - ${product.name} (Còn lại: ${product.max_quantity})`;
              option.dataset.price = product.unit_price;
              option.dataset.maxQty = product.max_quantity; // Số lượng còn lại trong PO
              option.dataset.unit = product.unit;
              if (productId === currentValue) option.selected = true;
              select.appendChild(option);
            });
          });
        })
        .catch(err => {
          console.error('Error loading PO:', err);
          alert('Không thể tải thông tin PO. Vui lòng thử lại.');
        });
    });
  }

  // Khi chọn sản phẩm, set đơn giá và giới hạn số lượng
  tbody.addEventListener("change", function(e) {
    if (e.target.classList.contains('product-select')) {
      const row = e.target.closest('tr');
      const priceInput = row.querySelector('input[name$="-unit_price"]');
      const qtyInput = row.querySelector('input[name$="-quantity"]');
      const selectedOption = e.target.options[e.target.selectedIndex];

      if (selectedOption && selectedOption.dataset.price) {
        // Set đơn giá từ PO (mặc định của nhà cung cấp)
        priceInput.value = parseInt(selectedOption.dataset.price) || 0;
        priceInput.readOnly = true
        // Set đơn vị tự động theo PO
    const unitInput = row.querySelector('input[name$="-unit"]');
    if (selectedOption.dataset.unit) {
        unitInput.value = selectedOption.dataset.unit;
    }
    unitInput.readOnly = true;
        // Giới hạn số lượng <= số lượng trong PO
        if (selectedOption.dataset.maxQty) {
          const maxQty = parseInt(selectedOption.dataset.maxQty);
          qtyInput.max = maxQty;
          qtyInput.placeholder = `Tối đa: ${maxQty}`;
          qtyInput.setAttribute('data-max', maxQty);
        }

        updateLineTotals();
      }
    }

    // Validate số lượng khi nhập
    if (e.target.name && e.target.name.indexOf("-quantity") !== -1) {
      const qtyInput = e.target;
      const maxQty = parseInt(qtyInput.getAttribute('data-max') || qtyInput.max || 999999);
      let enteredQty = parseInt(qtyInput.value) || 0;

      // không được ≤ 0
      if (enteredQty <= 0) {
        alert("Số lượng phải lớn hơn 0.");
        qtyInput.value = "";
        updateLineTotals();
        return;
      }

      if (enteredQty > maxQty) {
        alert(`Số lượng không được vượt quá ${maxQty} (số lượng còn lại trong PO).`);
        qtyInput.value = maxQty;
      }
      updateLineTotals();
    }
  });

  function updateLineTotals() {
    let grandTotal = 0;
    tbody.querySelectorAll("tr").forEach(function (row) {
      const qtyInput = row.querySelector('input[name$="-quantity"]');
      const priceInput = row.querySelector('input[name$="-unit_price"]');
      const totalCell = row.querySelector(".line-total");
      if (!qtyInput || !priceInput || !totalCell) return;

      const qty = parseFloat(qtyInput.value || 0);
      const price = parseFloat(priceInput.value || 0);
      const total = qty * price;
      totalCell.textContent = isNaN(total)
        ? "0 ₫"
        : total.toLocaleString("vi-VN") + " ₫";
      grandTotal += total;
    });

    if (grandTotalCell) {
      grandTotalCell.textContent = grandTotal.toLocaleString("vi-VN") + " ₫";
    }
  }

  addButton.addEventListener("click", function(e) {
    e.preventDefault();
    const formIndex = parseInt(totalForms.value);
    const newRow = firstRow.cloneNode(true);

    newRow.innerHTML = newRow.innerHTML.replace(/items-\d+/g, `items-${formIndex}`);

    newRow.querySelectorAll("input, select").forEach(el => {
      if (el.type === "checkbox") {
        el.checked = false;
      } else {
        el.value = "";
      }
    });

    // Đảm bảo select product mới cũng có class product-select
    const newProductSelect = newRow.querySelector('select[name$="-product"]');
    if (newProductSelect) {
      newProductSelect.classList.add('product-select');
    }

    // Cập nhật select sản phẩm nếu đã chọn PO
    if (poSelect && poSelect.value) {
      // gọi lại change để đổ danh sách sản phẩm
      poSelect.dispatchEvent(new Event('change'));
    }

    tbody.appendChild(newRow);
    totalForms.value = formIndex + 1;
    updateLineTotals();
  });

  // Cập nhật tổng tiền khi thay đổi số lượng hoặc đơn giá
  tbody.addEventListener("input", function(e) {
    if (e.target.name && (e.target.name.indexOf("-quantity") !== -1 || e.target.name.indexOf("-unit_price") !== -1)) {
      updateLineTotals();
    }
  });

  // validate lần cuối trước khi submit – không cho lưu nếu có quantity ≤0 hoặc rỗng
  if (asnForm) {
    asnForm.addEventListener("submit", function(e) {
      const qtyInputs = tbody.querySelectorAll('input[name$="-quantity"]');
      for (let input of qtyInputs) {
        if (!input.value || parseInt(input.value) <= 0) {
          alert("Tất cả số lượng sản phẩm phải lớn hơn 0.");
          e.preventDefault();
          return;
        }
      }
    });
  }

  updateLineTotals();
});
</script>
{% endblock %}
