{% extends "base.html" %}
{% load humanize %}
{% block title %}T·∫°o phi·∫øu giao h√†ng (ASN) - TH True Mart{% endblock %}
{% block page_title %}T·∫°o phi·∫øu giao h√†ng (ASN){% endblock %}

{% block extra_head %}
<style>
  .hero-card {
    border-radius: 16px;
    background: linear-gradient(135deg, #0d6efd, #38bdf8);
    color: #fff;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
    margin-bottom: 18px;
  }
  .hero-card h5 {
    margin: 0 0 4px;
    font-weight: 600;
  }
  .hero-card p {
    margin: 0;
    font-size: 14px;
    opacity: 0.92;
  }
  .hero-icon {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  .table th, .table td {
    vertical-align: middle !important;
  }
  .table input, .table select {
    height: 38px;
    font-size: 14px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- HERO -->
  <div class="hero-card">
    <div>
      <h5>T·∫°o phi·∫øu giao h√†ng (ASN)</h5>
      <p>Li√™n k·∫øt v·ªõi PO, ki·ªÉm so√°t s·ªë l∆∞·ª£ng giao ‚â§ s·ªë l∆∞·ª£ng ƒë·∫∑t.</p>
    </div>
    <div class="hero-icon">
      <i class="fa-solid fa-truck"></i>
    </div>
  </div>

  <!-- TH√îNG B√ÅO L·ªñI FORM CHUNG -->
  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {{ form.non_field_errors }}
    </div>
  {% endif %}
  {% if formset.non_field_errors %}
    <div class="alert alert-danger">
      {{ formset.non_field_errors }}
    </div>
  {% endif %}

  <!-- üîπ NEW: th√™m id ƒë·ªÉ b·∫Øt submit validate -->
  <form method="post" id="asnForm">
    {% csrf_token %}

    <!-- Th√¥ng tin chung -->
    <div class="card p-3 mb-3 shadow-sm">
      <h6 class="fw-semibold text-primary mb-3">Th√¥ng tin phi·∫øu giao h√†ng</h6>
      <div class="row g-3">
        <div class="col-md-3">
          {{ form.asn_code.label_tag }}
          {{ form.asn_code }}
          {{ form.asn_code.errors }}
        </div>

        <div class="col-md-3">
          {{ form.po.label_tag }}
          <select name="po" id="id_po" class="form-select">
              <option value="">---------</option>
              {% for p in allowed_po %}
                  <option value="{{ p.pk }}"
                    {% if form.initial.po and form.initial.po.pk == p.pk %}selected{% endif %}>
                      {{ p.po_code }} ‚Äî {{ p.supplier.company_name }}
                  </option>
              {% endfor %}
          </select>
          {% if form.po.errors %}
              <div class="text-danger small">{{ form.po.errors }}</div>
          {% endif %}
          <small class="text-muted d-block" style="font-size:11px;">
            * Ch·ªâ hi·ªÉn th·ªã PO thu·ªôc nh√† cung ·ª©ng c·ªßa b·∫°n.
          </small>
        </div>

        <!-- üîπ NEW: Supplier auto cho NCC, kh√¥ng cho ch·ªçn sai -->
<!--        <div class="col-md-3">-->
<!--    {{ form.supplier.label_tag }}-->

<!--    {% if user.is_authenticated and user.supplier %}-->
<!--        &lt;!&ndash; Hi·ªÉn th·ªã t√™n NCC cho ƒë·∫πp, kh√¥ng cho ch·ªânh &ndash;&gt;-->
<!--        <input type="text" class="form-control"-->
<!--               value="{{ user.supplier.company_name }}"-->
<!--               readonly style="background:#e9ecef;">-->

<!--        &lt;!&ndash; G·ª≠i id th·∫≠t l√™n server b·∫±ng hidden &ndash;&gt;-->
<!--        <input type="hidden"-->
<!--               name="{{ form.supplier.html_name }}"-->
<!--               value="{{ user.supplier.id }}">-->
<!--    {% else %}-->
<!--        &lt;!&ndash; Admin / Manager v·∫´n c√≥ dropdown &ndash;&gt;-->
<!--        {{ form.supplier }}-->
<!--    {% endif %}-->

<!--    {{ form.supplier.errors }}-->

<!--    <small class="text-muted d-block" style="font-size:11px;">-->
<!--        * T·ª± ƒë·ªông theo t√†i kho·∫£n nh√† cung ·ª©ng, kh√¥ng th·ªÉ thay ƒë·ªïi.-->
<!--    </small>-->
<!--</div>-->


        <div class="col-md-3">
          {{ form.expected_date.label_tag }}
          {{ form.expected_date }}
          {{ form.expected_date.errors }}
        </div>

        <div class="col-md-3">
          {{ form.deliverer_name.label_tag }}
          {{ form.deliverer_name }}
          {{ form.deliverer_name.errors }}
        </div>
        <div class="col-md-3">
          {{ form.deliverer_phone.label_tag }}
          {{ form.deliverer_phone }}
          {{ form.deliverer_phone.errors }}
        </div>
        <div class="col-md-3">
          {{ form.status.label_tag }}
          {{ form.status }}
          {{ form.status.errors }}
        </div>
        <div class="col-md-3">
          {{ form.note.label_tag }}
          {{ form.note }}
          {{ form.note.errors }}
        </div>
      </div>
    </div>

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold text-primary mb-0">Danh s√°ch s·∫£n ph·∫©m giao</h6>
        <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
          <i class="fa-solid fa-plus me-1"></i> Th√™m d√≤ng
        </button>
      </div>

      {{ formset.management_form }}
      <table class="table table-bordered align-middle text-center mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 25%">S·∫£n ph·∫©m</th>
            <th style="width: 10%">S·ªë l∆∞·ª£ng</th>
            <th style="width: 10%">ƒê∆°n v·ªã</th>
            <th style="width: 15%">ƒê∆°n gi√° (‚Ç´)</th>
            <th style="width: 15%">Th√†nh ti·ªÅn (‚Ç´)</th>
            <th style="width: 15%">H·∫°n s·ª≠ d·ª•ng</th>
            <th style="width: 5%">X√≥a</th>
          </tr>
        </thead>
        <tbody id="item-body">
          {% for f in formset.forms %}
          <tr class="align-middle">
            <td>
              {{ f.product }}
              {{ f.product.errors }}
              <small class="text-muted d-block" style="font-size:11px;">
                Ch·ªâ t·ª´ PO ƒë√£ ch·ªçn.
              </small>
            </td>
            <td>
              {{ f.quantity }}
              {{ f.quantity.errors }}
              <small class="text-muted d-block" style="font-size:11px;">
                ‚â§ SL trong PO, &gt; 0.
              </small>
            </td>
            <td>
              {{ f.unit }}
              {{ f.unit.errors }}
            </td>
            <td>
              {{ f.unit_price }}
              {{ f.unit_price.errors }}
              <small class="text-muted d-block" style="font-size:11px;">
                T·ª± ƒë·ªông t·ª´ PO.
              </small>
            </td>
            <td class="text-end fw-semibold text-primary">
              <span class="line-total">0 ‚Ç´</span>
            </td>
            <td>
              {{ f.expiry_date }}
              {{ f.expiry_date.errors }}
            </td>
            <td>
              {% if formset.can_delete %}
                {{ f.DELETE }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light fw-semibold">
          <tr>
            <td colspan="4" class="text-end">T·ªïng c·ªông:</td>
            <td class="text-end text-primary fs-5" id="grand-total">0 ‚Ç´</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="text-end mt-3">
      <a href="{% url 'asn_list' %}" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left-long me-1"></i> Quay l·∫°i
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-floppy-disk me-1"></i> L∆∞u phi·∫øu giao h√†ng
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const addButton = document.getElementById("add-row");
  const totalForms = document.getElementById("id_items-TOTAL_FORMS");
  const tbody = document.getElementById("item-body");
  const poSelect = document.getElementById("id_po");
  const grandTotalCell = document.getElementById("grand-total");
  const asnForm = document.getElementById("asnForm");

  if (!tbody) return;
  const firstRow = tbody.querySelector("tr");
  if (!firstRow) return;

  let poProducts = {}; // S·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng trong PO

  // üîπ NEW: g·∫Øn class product-select cho t·∫•t c·∫£ select product (kh√¥ng c·∫ßn add_class)
  tbody.querySelectorAll('select[name$="-product"]').forEach(sel => {
    sel.classList.add('product-select');
  });

  // ‚úÖ Khi ch·ªçn PO, t·ª± ƒë·ªông set nh√† cung c·∫•p v√† filter s·∫£n ph·∫©m
  if (poSelect) {
    poSelect.addEventListener("change", function() {
      const poId = this.value;
      if (!poId) {
        tbody.querySelectorAll('.product-select').forEach(select => {
          select.innerHTML = '<option value="">-- Ch·ªçn PO tr∆∞·ªõc --</option>';
        });
        return;
      }

      // Fetch th√¥ng tin PO
      fetch(`/api/po-details/${poId}/`)
        .then(res => res.json())
        .then(data => {
          poProducts = data.products || {};

          // C·∫≠p nh·∫≠t select s·∫£n ph·∫©m
          tbody.querySelectorAll('.product-select').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>';
            Object.keys(poProducts).forEach(productId => {
              const product = poProducts[productId];
              const option = document.createElement('option');
              option.value = productId;
              option.textContent = `${product.code} - ${product.name} (C√≤n l·∫°i: ${product.max_quantity})`;
              option.dataset.price = product.unit_price;
              option.dataset.maxQty = product.max_quantity; // S·ªë l∆∞·ª£ng c√≤n l·∫°i trong PO
              if (productId === currentValue) option.selected = true;
              select.appendChild(option);
            });
          });
        })
        .catch(err => {
          console.error('Error loading PO:', err);
          alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin PO. Vui l√≤ng th·ª≠ l·∫°i.');
        });
    });
  }

  // ‚úÖ Khi ch·ªçn s·∫£n ph·∫©m, set ƒë∆°n gi√° v√† gi·ªõi h·∫°n s·ªë l∆∞·ª£ng
  tbody.addEventListener("change", function(e) {
    if (e.target.classList.contains('product-select')) {
      const row = e.target.closest('tr');
      const priceInput = row.querySelector('input[name$="-unit_price"]');
      const qtyInput = row.querySelector('input[name$="-quantity"]');
      const selectedOption = e.target.options[e.target.selectedIndex];

      if (selectedOption && selectedOption.dataset.price) {
        // ‚úÖ Set ƒë∆°n gi√° t·ª´ PO (m·∫∑c ƒë·ªãnh c·ªßa nh√† cung c·∫•p)
        priceInput.value = parseInt(selectedOption.dataset.price) || 0;

        // ‚úÖ Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng <= s·ªë l∆∞·ª£ng trong PO
        if (selectedOption.dataset.maxQty) {
          const maxQty = parseInt(selectedOption.dataset.maxQty);
          qtyInput.max = maxQty;
          qtyInput.placeholder = `T·ªëi ƒëa: ${maxQty}`;
          qtyInput.setAttribute('data-max', maxQty);
        }

        updateLineTotals();
      }
    }

    // ‚úÖ Validate s·ªë l∆∞·ª£ng khi nh·∫≠p
    if (e.target.name && e.target.name.indexOf("-quantity") !== -1) {
      const qtyInput = e.target;
      const maxQty = parseInt(qtyInput.getAttribute('data-max') || qtyInput.max || 999999);
      let enteredQty = parseInt(qtyInput.value) || 0;

      // üîπ NEW: kh√¥ng ƒë∆∞·ª£c ‚â§ 0
      if (enteredQty <= 0) {
        alert("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0.");
        qtyInput.value = "";
        updateLineTotals();
        return;
      }

      if (enteredQty > maxQty) {
        alert(`S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${maxQty} (s·ªë l∆∞·ª£ng c√≤n l·∫°i trong PO).`);
        qtyInput.value = maxQty;
      }
      updateLineTotals();
    }
  });

  function updateLineTotals() {
    let grandTotal = 0;
    tbody.querySelectorAll("tr").forEach(function (row) {
      const qtyInput = row.querySelector('input[name$="-quantity"]');
      const priceInput = row.querySelector('input[name$="-unit_price"]');
      const totalCell = row.querySelector(".line-total");
      if (!qtyInput || !priceInput || !totalCell) return;

      const qty = parseFloat(qtyInput.value || 0);
      const price = parseFloat(priceInput.value || 0);
      const total = qty * price;
      totalCell.textContent = isNaN(total)
        ? "0 ‚Ç´"
        : total.toLocaleString("vi-VN") + " ‚Ç´";
      grandTotal += total;
    });

    if (grandTotalCell) {
      grandTotalCell.textContent = grandTotal.toLocaleString("vi-VN") + " ‚Ç´";
    }
  }

  addButton.addEventListener("click", function(e) {
    e.preventDefault();
    const formIndex = parseInt(totalForms.value);
    const newRow = firstRow.cloneNode(true);

    newRow.innerHTML = newRow.innerHTML.replace(/items-\d+/g, `items-${formIndex}`);

    newRow.querySelectorAll("input, select").forEach(el => {
      if (el.type === "checkbox") {
        el.checked = false;
      } else {
        el.value = "";
      }
    });

    // ƒê·∫£m b·∫£o select product m·ªõi c≈©ng c√≥ class product-select
    const newProductSelect = newRow.querySelector('select[name$="-product"]');
    if (newProductSelect) {
      newProductSelect.classList.add('product-select');
    }

    // ‚úÖ C·∫≠p nh·∫≠t select s·∫£n ph·∫©m n·∫øu ƒë√£ ch·ªçn PO
    if (poSelect && poSelect.value) {
      // g·ªçi l·∫°i change ƒë·ªÉ ƒë·ªï danh s√°ch s·∫£n ph·∫©m
      poSelect.dispatchEvent(new Event('change'));
    }

    tbody.appendChild(newRow);
    totalForms.value = formIndex + 1;
    updateLineTotals();
  });

  // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn khi thay ƒë·ªïi s·ªë l∆∞·ª£ng ho·∫∑c ƒë∆°n gi√°
  tbody.addEventListener("input", function(e) {
    if (e.target.name && (e.target.name.indexOf("-quantity") !== -1 || e.target.name.indexOf("-unit_price") !== -1)) {
      updateLineTotals();
    }
  });

  // üîπ NEW: validate l·∫ßn cu·ªëi tr∆∞·ªõc khi submit ‚Äì kh√¥ng cho l∆∞u n·∫øu c√≥ quantity ‚â§0 ho·∫∑c r·ªóng
  if (asnForm) {
    asnForm.addEventListener("submit", function(e) {
      const qtyInputs = tbody.querySelectorAll('input[name$="-quantity"]');
      for (let input of qtyInputs) {
        if (!input.value || parseInt(input.value) <= 0) {
          alert("T·∫•t c·∫£ s·ªë l∆∞·ª£ng s·∫£n ph·∫©m ph·∫£i l·ªõn h∆°n 0.");
          e.preventDefault();
          return;
        }
      }
    });
  }

  updateLineTotals();
});
</script>
{% endblock %}
